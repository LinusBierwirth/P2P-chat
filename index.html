<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>P2P Chat Minimalist</title>
<style>
  body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
  textarea { width: 100%; height: 100px; font-size: 1em; margin-top: 10px; display: none; }
  #log { border: 1px solid #ccc; padding: 10px; height: 180px; overflow-y: auto; margin-top: 20px; display: none; }
  input { width: 100%; margin-top: 10px; font-size: 1em; display: none; }
  button { margin-top: 10px; }
</style>
</head>
<body>
<h2>P2P Chat</h2>

<button id="createOfferBtn">ðŸ“¤ Create Offer</button>
<textarea id="offerOut" readonly></textarea>

<textarea id="answerIn" placeholder="Paste answer here..."></textarea>
<button id="setAnswerBtn">Set Answer</button>

<div id="log"></div>
<input id="message" placeholder="Type message..." onkeydown="if(event.key==='Enter')sendMessage()" />

<script>
let pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
let channel;

function log(msg) {
  const logDiv = document.getElementById("log");
  logDiv.innerHTML += msg + "<br>";
  logDiv.scrollTop = logDiv.scrollHeight;
}

function base64(obj) {
  return btoa(JSON.stringify(obj));
}
function unbase64(str) {
  return JSON.parse(atob(str));
}

function showChatUI() {
  document.getElementById("createOfferBtn").style.display = "none";
  document.getElementById("offerOut").style.display = "none";
  document.getElementById("answerIn").style.display = "none";
  document.getElementById("setAnswerBtn").style.display = "none";
  document.getElementById("log").style.display = "block";
  document.getElementById("message").style.display = "block";
}

function setupChannel() {
  channel.onopen = () => {
    log("[Channel opened]");
    showChatUI();
  };
  channel.onmessage = e => log("Peer: " + e.data);
}

document.getElementById("createOfferBtn").onclick = () => {
  channel = pc.createDataChannel("chat");
  setupChannel();

  pc.onicecandidate = e => {
    if (e.candidate === null && pc.localDescription) {
      document.getElementById("offerOut").value = base64(pc.localDescription);
      document.getElementById("offerOut").style.display = "block";
      document.getElementById("answerIn").style.display = "block";
      document.getElementById("setAnswerBtn").style.display = "inline-block";
    }
  };

  pc.createOffer().then(o => pc.setLocalDescription(o));
};

document.getElementById("setAnswerBtn").onclick = () => {
  const txt = document.getElementById("answerIn").value.trim();
  if (!txt) return;
  try {
    const answer = unbase64(txt);
    pc.setRemoteDescription(answer);
  } catch {
    log("Invalid answer.");
  }
};

pc.ondatachannel = e => {
  channel = e.channel;
  setupChannel();
};

function sendMessage() {
  const input = document.getElementById("message");
  const msg = input.value.trim();
  if (!msg || !channel || channel.readyState !== "open") return;
  channel.send(msg);
  log("You: " + msg);
  input.value = "";
}
</script>
</body>
</html>



<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>P2P Chat Minimal</title>
<style>
  body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
  textarea { width: 100%; height: 100px; margin-top: 10px; font-size: 1em; }
  #log { border: 1px solid #ccc; padding: 10px; height: 180px; overflow-y: auto; margin-top: 10px; display: none; }
  input { width: 100%; margin-top: 10px; font-size: 1em; display: none; }
  button { margin-top: 10px; }
  #chatUI { display: none; }
</style>
</head>
<body>
<h2>P2P Chat</h2>

<div id="connectUI">
  <button onclick="generateOffer()">ðŸ“¤ Generate & Copy Offer</button><br>
  <button onclick="pasteAnswer()">ðŸ“¥ Paste Answer</button>
</div>

<div id="chatUI">
  <h3>Connected</h3>
  <div id="log"></div>
  <input id="message" placeholder="Type message..." onkeydown="if(event.key==='Enter')sendMessage()" />
</div>

<script>
let pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
let channel;

function log(msg) {
  const logDiv = document.getElementById("log");
  logDiv.innerHTML += msg + "<br>";
  logDiv.scrollTop = logDiv.scrollHeight;
}

function base64Encode(obj) {
  return btoa(JSON.stringify(obj));
}
function base64Decode(str) {
  return JSON.parse(atob(str));
}

function showChatUI() {
  document.getElementById("connectUI").style.display = "none";
  document.getElementById("chatUI").style.display = "block";
  document.getElementById("log").style.display = "block";
  document.getElementById("message").style.display = "block";
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => alert("Offer copied to clipboard!"));
}

function generateOffer() {
  channel = pc.createDataChannel("chat");
  setupChannel();

  pc.onicecandidate = e => {
    if (e.candidate === null && pc.localDescription) {
      const encoded = base64Encode(pc.localDescription);
      const offerUrl = `${location.origin}${location.pathname}?offer=${encodeURIComponent(encoded)}`;
      copyToClipboard(offerUrl);
    }
  };

  pc.createOffer().then(o => pc.setLocalDescription(o));
}

function pasteAnswer() {
  const answer = prompt("Paste the answer JSON:");
  if (!answer) return;
  try {
    const parsed = JSON.parse(answer);
    pc.setRemoteDescription(parsed);
  } catch (e) {
    alert("Invalid answer format.");
  }
}

function sendMessage() {
  const input = document.getElementById("message");
  const msg = input.value.trim();
  if (!msg || !channel || channel.readyState !== "open") return;
  channel.send(msg);
  log("You: " + msg);
  input.value = "";
}

function setupChannel() {
  channel.onopen = () => {
    log("[Channel opened]");
    showChatUI();
  };
  channel.onmessage = e => log("Peer: " + e.data);
}

pc.ondatachannel = e => {
  channel = e.channel;
  setupChannel();
};

// Auto-handle incoming offer via URL
window.onload = () => {
  const params = new URLSearchParams(location.search);
  if (params.has("offer")) {
    try {
      const offer = base64Decode(params.get("offer"));
      pc.setRemoteDescription(offer)
        .then(() => pc.createAnswer())
        .then(answer => pc.setLocalDescription(answer));

      pc.onicecandidate = e => {
        if (e.candidate === null && pc.localDescription) {
          alert("Copy this answer and send it back:\n\n" + JSON.stringify(pc.localDescription));
        }
      };
    } catch {
      alert("Invalid offer in URL.");
    }
  }
};
</script>
</body>
</html>

